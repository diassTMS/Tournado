{% extends "base.html" %}
{% load static %}
{% load crispy_forms_tags %}
{% block container %}
    <style>
        #searchGrid {
            grid-template-columns: 2fr 1fr;
            grid-auto-flow: row;
        }

        #filterGroup {
            display:inline-flex; 
            gap:20px;
        }

        @media (width < 50em) {
            #searchGrid {
                display: grid;
                grid-template-columns: 3fr 2fr;
            }

            #filterGroup {
                display:inline-flex; 
                gap:10px;
            }
        }

        #dup-action {
            color: #0077cc; /* default Pico primary blue */
            cursor: pointer;
            transition: color 0.2s ease;
        }
        #dup-action:hover {
            color: #003961; /* darker on hover */
        }
        #del-action {
            color: #AF291D; /* default Pico primary blue */
            cursor: pointer;
            transition: color 0.2s ease;
        }
        #del-action:hover {
            color: #5e150e; /* darker on hover */
        }

    </style>

    <section>
        <div id="box">
            <div class="grid">
                <hgroup>
                    <h2>
                        <i onClick="location.href='{% url 'account' %}';" class="fa-solid fa-circle-arrow-left" id="icon"></i> 
                        Your Events
                    </h2>
                    <p>        
                        &emsp;&emsp;<i class="fa-solid fa-circle-info"></i>
                        <span><b>Toggle between your past and future events</b></span>
                    </p> 
                </hgroup>
                <div role="group">
                    <button style="width: 50%;" class="primary" id="futureButton">Upcoming</button>
                    <button style="width: 50%;" class="secondary" id="pastButton">Past</button>
                </div>
            </div>
        </div>
        <br>
        <form method="post">
            {% csrf_token %}
            <input type="hidden" name="current_block" id="current_block" value="future">

            <!-- Future tournaments -->
            <div id="futureBlock">
                <div class='container' id='box'>
                    <div class="grid">
                        <h2 style="margin-top: 10px;">Upcoming Events</h2>
                        <div class="grid" id="searchGrid">
                            <input type="search" id="searchTournFuture" name="search" placeholder="Search" />
                            <div class="group" id="filterGroup">
                                <button type="button" onclick="filterView()" style="all: unset;">
                                    <h1><i class="fa-solid fa-sliders" id="icon"></i></h1>
                                </button>
                                <button type="submit" name="action" value="duplicate" onclick="return confirmDuplicate()" style="all: unset;">
                                    <h1><i id="dup-action" class="fa-solid fa-clone"></i></h1>
                                </button>
                                <button type="submit" name="action" value="delete" onclick="return confirmDelete()" style="all: unset;">
                                    <h1><i id="del-action" class="fa-solid fa-trash"></i></h1>
                                </button>
                            </div>
                        </div>
                    </div>
                    <hr>

                    <!-- Filter fieldset (no nested form) -->
                    <fieldset id="filterFuture" style="display: none;">
                        <div class="grid">
                            <label>Age {{ filterFuture.form.age }}</label>
                            <label>Gender {{ filterFuture.form.gender }}</label>
                            <label>Group {{ filterFuture.form.group }}</label>
                            <label>Date {{ filterFuture.form.date }}</label>
                            <label>&ensp;<input id="resetFuture" class="secondary" type="button" onclick="reset()" value="Clear" /></label>
                        </div>
                        <hr>
                    </fieldset>

                    <div id="user-future-tourns">
                        {% include 'include/user-future-tourns.html' %}
                    </div>
                </div>
            </div>

            <!-- Past tournaments -->
            <div id="pastBlock">
                <div class='container' id='box'>
                    <div class="grid">
                        <h2 style="margin-top: 10px;">Past Events</h2>
                        <div class="grid" id="searchGrid">
                            <input type="search" id="searchTournPast" name="search" placeholder="Search" />
                            <div class="group" id="filterGroup">
                                <button type="button" onclick="filterViewPast()" style="all: unset;">
                                    <h1><i class="fa-solid fa-sliders" id="icon"></i></h1>
                                </button>
                                <button type="submit" name="action" value="duplicate" onclick="return confirmDuplicate()" style="all: unset;">
                                    <h1><i id="dup-action" class="fa-solid fa-clone"></i></h1>
                                </button>
                                <button type="submit" name="action" value="delete" onclick="return confirmDelete()" style="all: unset;">
                                    <h1><i id="del-action" class="fa-solid fa-trash"></i></h1>
                                </button>
                            </div>
                        </div>
                    </div>
                    <hr>

                    <!-- Filter fieldset (no nested form) -->
                    <fieldset class="grid" id="filterPast" style="display: none;">
                        <div class="grid">
                            <label>Age {{ filterPast.form.age }}</label>
                            <label>Gender {{ filterPast.form.gender }}</label>
                            <label>Group {{ filterPast.form.group }}</label>
                            <label>Date {{ filterPast.form.date }}</label>
                            <label>&ensp;<input id="resetPast" class="secondary" type="button" onclick="reset()" value="Clear" /></label>
                        </div>
                        <hr>
                    </fieldset>

                    <div id="user-past-tourns">
                        {% include 'include/user-past-tourns.html' %}
                    </div>
                </div>
            </div>
        </form>
    </section>

    <script src="https://ajax.googleapis.com/ajax/libs/jquery/1.11.1/jquery.min.js"></script>
    <script>

        //Past or Future Views
        document.getElementById("futureButton").addEventListener("click",function(e) {
            document.getElementById("futureBlock").style.display = "block";
            document.getElementById("pastBlock").style.display = "none";
            document.getElementById("futureButton").className = "primary";
            document.getElementById("pastButton").className = "secondary";   
            document.getElementById("current_block").value = "future";         
        });

        document.getElementById("pastButton").addEventListener("click",function(e) {
            document.getElementById("futureBlock").style.display = "none";
            document.getElementById("pastBlock").style.display = "block";  
            document.getElementById("futureButton").className = "secondary";
            document.getElementById("pastButton").className = "primary";
            document.getElementById("current_block").value = "past";            
        });
        
        window.onload = function() {
            const current = "{{ current_block }}";
            if (current === "past") {
                document.getElementById("futureBlock").style.display = "none";
                document.getElementById("pastBlock").style.display = "block";
                document.getElementById("futureButton").className = "secondary";
                document.getElementById("pastButton").className = "primary";
            } else {
                document.getElementById("futureBlock").style.display = "block";
                document.getElementById("pastBlock").style.display = "none";
                document.getElementById("futureButton").className = "primary";
                document.getElementById("pastButton").className = "secondary";
            };
        };

        function filterView() {
            var x = document.getElementById("filterFuture");
            if (x.style.display === "none") {
              x.style.display = "block";
            } else {
              x.style.display = "none";
            }
        }

        function filterViewPast() {
            var x = document.getElementById("filterPast");
            if (x.style.display === "none") {
              x.style.display = "block";
            } else {
              x.style.display = "none";
            }
        }

        document.querySelectorAll("#filterFuture select, #filterFuture input").forEach(el => {
            el.addEventListener("change", function(evt) {
                evt.preventDefault();
                const filter = document.getElementById("filterFuture");
                const age = filter.querySelector("[name='age']").value;
                const gender = filter.querySelector("[name='gender']").value;
                const group = filter.querySelector("[name='group']").value;
                const date = filter.querySelector("[name='date']").value;
                const search = document.getElementById("searchTournFuture").value;
                
                $.ajax({
                    method: 'GET',
                    dataType: 'json',
                    url: 'search-future/',
                    data: {'age': age,
                            'gender': gender,
                            'group': group,
                            'date': date,
                            'data': search,
                        },
                    success : function (data) {
                        $('#user-future-tourns').html(data.result)
                    }
                })
            })
        });

        document.getElementById("resetFuture").addEventListener("click",function(evt) {
            evt.preventDefault();
            const filter = document.getElementById("filterFuture");
            filter.querySelector("[name='age']").value = "";
            filter.querySelector("[name='gender']").value = "";
            filter.querySelector("[name='group']").value = "";
            filter.querySelector("[name='date']").value = "";
            
            // Trigger AJAX to reload unfiltered results
            const search = document.getElementById("searchTournFuture").value;
            $.ajax({
                method: 'GET',
                dataType: 'json',
                url: 'search-future/',
                data: {'age':'', 'gender':'', 'group':'', 'date':'', 'data': search},
                success: function(data) {
                    $('#user-future-tourns').html(data.result);
                }
            });
        });

        document.querySelectorAll("#filterPast select, #filterPast input").forEach(el => {
            el.addEventListener("change", function(evt) {
                evt.preventDefault();
                const filter = document.getElementById("filterPast");
                const age = filter.querySelector("[name='age']").value;
                const gender = filter.querySelector("[name='gender']").value;
                const group = filter.querySelector("[name='group']").value;
                const date = filter.querySelector("[name='date']").value;
                const search = document.getElementById("searchTournPast").value;
            
                $.ajax({
                    method: 'GET',
                    dataType: 'json',
                    url: 'search-past/',
                    data: {'age': age,
                            'gender': gender,
                            'group': group,
                            'date': date,
                            'data': search,
                        },
                    success : function (data) {
                        $('#user-past-tourns').html(data.result)
                    }
                })
            })
        });

        document.getElementById("resetPast").addEventListener("click",function(evt) {
            evt.preventDefault();
            const filter = document.getElementById("filterPast");
            filter.querySelector("[name='age']").value = "";
            filter.querySelector("[name='gender']").value = "";
            filter.querySelector("[name='group']").value = "";
            filter.querySelector("[name='date']").value = "";
            
            const search = document.getElementById("searchTournPast").value;
            $.ajax({
                method: 'GET',
                dataType: 'json',
                url: 'search-past/',
                data: {'age':'', 'gender':'', 'group':'', 'date':'', 'data': search},
                success: function(data) {
                    $('#user-past-tourns').html(data.result);
                }
            });
        });

        document.getElementById("searchTournFuture").onsearch = function (evt) {
            evt.preventDefault();
            const data = $(this).val();
            $.ajax({
                method: 'GET',
                dataType: 'json',
                url: 'search-future/',
                data: {'data': data},
                success : function (data) {
                    $('#user-future-tourns').html(data.result)
                }
            })
        };

        document.getElementById("searchTournFuture").addEventListener("keypress", function(event) {
            // If the user presses the "Enter" key on the keyboard
            if (event.keyCode == 13) {
                event.preventDefault();
                const data = $(this).val();
                $.ajax({
                    method: 'GET',
                    dataType: 'json',
                    url: 'search-future/',
                    data: {'data': data},
                    success : function (data) {
                        $('#user-future-tourns').html(data.result)
                    }
                })
            }
        });

        //Past tournaments
        document.getElementById("searchTournPast").onsearch = function (evt) {
            evt.preventDefault();
            const data = $(this).val();
            $.ajax({
                method: 'GET',
                dataType: 'json',
                url: 'search-past/',
                data: {'data': data},
                success : function (data) {
                    $('#user-past-tourns').html(data.result)
                }
            })
        };

        document.getElementById("searchTournPast").addEventListener("keypress", function(event) {
            // If the user presses the "Enter" key on the keyboard
            if (event.keyCode == 13) {
                event.preventDefault();
                const data = $(this).val();
                $.ajax({
                    method: 'GET',
                    dataType: 'json',
                    url: 'search-past/',
                    data: {'data': data},
                    success : function (data) {
                        $('#user-past-tourns').html(data.result)
                    }
                })
            }
        });

        function confirmDelete() {
            const checked = document.querySelectorAll('input[name="selected_tournaments"]:checked');
            if (!checked.length) { alert("No tournaments selected."); return false; }
            document.getElementById("current_block").value = document.getElementById("pastBlock").style.display === "block" ? "past" : "future";
            return confirm("Are you sure you want to delete the selected tournament(s)? This action cannot be undone.");
        };

        function confirmDuplicate() {
            const checked = document.querySelectorAll('input[name="selected_tournaments"]:checked');
            if (!checked.length) { alert("No tournaments selected."); return false; }
            document.getElementById("current_block").value = document.getElementById("pastBlock").style.display === "block" ? "past" : "future";
            return confirm("Are you sure you want to duplicate the selected tournament(s)?");
        };

    </script>

{% endblock %}